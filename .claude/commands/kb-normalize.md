# kb:normalize — Apply terminology fixes from standardizer report

## Purpose
Read the terminology dictionary and inconsistency report generated by `kb:standardizer`, then apply canonical term replacements across all `content/*.md` files. Designed to run right after `kb:standardizer` as a two-step pipeline.

## Pipeline
```
kb:standardizer  →  build/terminology/dictionary.json
                    build/terminology/inconsistencies.md
                           ↓
kb:normalize     →  applies fixes to content/*.md
                    writes build/terminology/normalize-log.md
                    updates dictionary.json with last_normalized timestamp
```

## Inputs
- `build/terminology/dictionary.json` (required — run `kb:standardizer` first if missing)
- `build/terminology/inconsistencies.md` (for reference)
- All `.md` files in `content/`

## Outputs
- Updated `content/*.md` files with normalized terminology
- `build/terminology/normalize-log.md` — changelog of every replacement made
- Updated `build/terminology/dictionary.json` — adds `last_normalized` timestamp

## Replacement rules

### What to replace
Only replace terms that belong to a **synonym cluster** (have `variants_found` with more than one entry). Replace non-canonical variants with the canonical term.

### What NOT to replace
- Text inside YAML frontmatter (between `---` fences)
- Text inside code blocks (``` fences) or inline `code`
- Image alt text and image paths
- URL paths and link URLs
- Proper nouns that happen to match (e.g. "GoCardless Direct Debit" — don't touch "Direct")
- Terms inside quotes when they refer to UI labels as-is (e.g. `the "Group" tab`)
- The word "course" in "course of" (natural English, not Zooza concept)
- The word "term" when meaning "word/phrase" not "billing period"
- The word "event" in compound phrases like "event notification", "event reminder" where it's an established feature name in Zooza UI

### Context-aware rules
1. **programme ← course**: Replace "course" with "programme" EXCEPT:
   - In URLs or slugs
   - When part of a compound like "of course"

2. **class ← group/timetable**: Replace EXCEPT:
   - "group" in "group connection" (Zooza feature name — check if this is a real feature)
   - "group" in "Group Interested" (Zooza feature name)

3. **session ← event/lesson**: Replace EXCEPT:
   - In file slugs, headings, or feature names that use "event" or "lesson" as the established Zooza UI term
   - "lesson" in "make-up lesson" (keep as-is, it's the canonical form)
   - Check: if the Zooza admin UI actually says "Event" or "Lesson" in menus, keep those references intact and flag for human review

4. **booking ← registration**: Replace EXCEPT:
   - In admin-context docs where "registration" is a distinct Zooza concept (status, workflow)
   - Flag these for human review rather than auto-replacing

5. **instructor ← lecturer/tutor/trainer/teacher**: Safe to replace everywhere.

6. **client ← customer**: Safe to replace everywhere.

7. **Parent Zone ← parent portal**: Replace everywhere.

8. **payment plan ← payment template**: Replace in prose; keep "template" when referring to the actual Zooza settings UI object.

### Preserving case
Match the case of the original term:
- "Course" → "Programme", "course" → "programme", "COURSE" → "PROGRAMME"
- "Group" → "Class", "group" → "class"
- "Registration" → "Booking", "registration" → "booking"

## Idempotency rules (prevent loops)

1. **Skip already-canonical files**: If a file contains zero non-canonical variants, skip it entirely.
2. **Stamp processed files**: After normalizing, the log records each file + its content hash. On re-run, skip files whose hash hasn't changed since last normalization.
3. **Never replace canonical → something else**: The script only replaces variant → canonical, never the reverse.
4. **Track in dictionary.json**: Add `"last_normalized": "YYYY-MM-DD"` after successful run. If `last_normalized` >= `extracted_at`, warn that standardizer should be re-run first to pick up any new content.

## Human review flags
Some replacements are risky. Instead of auto-replacing, add a comment in `normalize-log.md`:
- `REVIEW: "registration" in admin context — may be intentional`
- `REVIEW: "event" in feature name — may be Zooza UI label`
- `REVIEW: "group" in "Group Interested" — Zooza feature name`
- `REVIEW: "term" — ambiguous (billing period vs. word)`

## Normalize log format

```markdown
# Normalize Log

**Run:** 2026-02-11
**Files scanned:** 85
**Files modified:** N
**Total replacements:** N
**Skipped (already canonical):** N

## Replacements by term

| From | To | Count | Files |
|---|---|---|---|
| course | programme | 120 | 34 |
| group | class | 95 | 28 |
| registration | booking | 80 | 25 |
| ...

## Modified files

### getting-started-with-zooza.md
- "timetable" → "class" (37x)
- "course" → "programme" (2x)
- "payment template" → "payment plan" (8x)

### blocks-creation.md
- "group" → "class" (13x)
- "customer" → "client" (1x)

## Items flagged for review

- `multi-day-event-with-product-offer.md:32` — "registration" in admin workflow context
- `online-registration.md:title` — slug contains "registration" (do not change slugs)
```

## Safety
- **Never modify frontmatter** (title, slug, tags, etc.)
- **Never modify file names or slugs** — only prose content
- **Create a git-friendly diff** — make minimal changes, don't rewrite entire files
- **Dry-run first**: Before writing changes, print summary and ask for confirmation unless user passed `--apply` or explicitly asked to apply

## Intercom sync flag
After modifying a content file, set `intercom_sync: true` in its frontmatter so the next deploy will update the Intercom article. If `intercom_sync` is not present in the frontmatter, add it.

## Done definition
Complete when:
- All safe replacements applied to content files
- `intercom_sync: true` set on all modified files
- `normalize-log.md` written with full changelog
- `dictionary.json` updated with `last_normalized`
- Review items clearly flagged
- Re-running `kb:standardizer` after normalize shows reduced inconsistencies
